# Start with Ubuntu base image
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies
RUN apt-get update && apt-get install -y \
    software-properties-common \
    gnupg \
    curl \
    openssh-server \
    maven \
    git \
    vim \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# Install Amazon Corretto 21
RUN curl -fsSL https://apt.corretto.aws/corretto.key | gpg --dearmor | tee /usr/share/keyrings/corretto-keyring.gpg >/dev/null && \
    echo "deb [signed-by=/usr/share/keyrings/corretto-keyring.gpg] https://apt.corretto.aws stable main" | tee /etc/apt/sources.list.d/corretto.list && \
    apt-get update && apt-get install -y java-21-amazon-corretto-jdk && \
    rm -rf /var/lib/apt/lists/*

# Set Java home
ENV JAVA_HOME=/usr/lib/jvm/java-21-amazon-corretto
ENV PATH=$JAVA_HOME/bin:$PATH

# Configure SSH
RUN mkdir /var/run/sshd && \
    echo 'root:devpassword' | chpasswd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' /etc/pam.d/sshd

# Set working directory
WORKDIR /app

# Copy Spring Boot project (optional)
COPY . /app

# Expose SSH port and Spring Boot app port
EXPOSE 22 8080

# Start SSH server
CMD ["/usr/sbin/sshd", "-D"]
